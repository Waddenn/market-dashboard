name: Deploy to LXC via Tailscale

on:
  workflow_dispatch:
  workflow_run:
    workflows:
      - Build and Push Docker Image to GHCR
    branches:
      - main
    types:
      - completed

jobs:
  deploy:
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:github-ci

      - name: Deploy latest container
        env:
          TS_HOST: ${{ secrets.LXC_TAILSCALE_HOST }}
          TS_USER: ${{ secrets.LXC_TAILSCALE_USER }}
        run: |
          set -euo pipefail

          if [ -z "${TS_HOST:-}" ]; then
            echo "Secret LXC_TAILSCALE_HOST is not set" >&2
            exit 1
          fi

          if [ -z "${TS_USER:-}" ]; then
            echo "Secret LXC_TAILSCALE_USER is not set" >&2
            exit 1
          fi

          SSH_TARGET="${TS_USER}@${TS_HOST}"

          tailscale ping -c 4 "$TS_HOST"

          tailscale ssh "$SSH_TARGET" <<'EOF'
          set -euo pipefail

          docker pull ghcr.io/waddenn/bourse-dashboard:latest

          if docker ps --format '{{.Names}}' | grep -q '^bourse-container$'; then
            docker stop bourse-container
          fi

          if docker ps -a --format '{{.Names}}' | grep -q '^bourse-container$'; then
            docker rm bourse-container
          fi

          docker run -d \
            -p 5000:5000 \
            --name bourse-container \
            --restart unless-stopped \
            -e TZ=Europe/Paris \
            -v /etc/localtime:/etc/localtime:ro \
            ghcr.io/waddenn/bourse-dashboard:latest
          EOF
